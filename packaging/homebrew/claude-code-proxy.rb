class ClaudeCodeProxy < Formula
  include Language::Python::Virtualenv

  desc "Multi-account Claude Code proxy server with automatic rotation"
  homepage "https://github.com/joachimbrindeau/claude-proxy-multi"
  url "https://files.pythonhosted.org/packages/source/c/claude-code-proxy/claude-code-proxy-0.1.0.tar.gz"
  sha256 "PLACEHOLDER_SHA256"  # Will be updated by CI on release
  license "MIT"

  depends_on "python@3.12"

  # Python dependencies will be auto-generated by homebrew-pypi-poet
  # Run: poet claude-code-proxy > resources.txt
  # Or: brew update-python-resources packaging/homebrew/claude-code-proxy.rb

  # Core dependencies (placeholder - will be replaced by poet)
  resource "fastapi" do
    url "https://files.pythonhosted.org/packages/source/f/fastapi/fastapi-0.115.6.tar.gz"
    sha256 "9ec46f7addc14ea472958a96aae5b5de65f39721a46aaf5705c480d9a8b76654"
  end

  resource "uvicorn" do
    url "https://files.pythonhosted.org/packages/source/u/uvicorn/uvicorn-0.34.0.tar.gz"
    sha256 "404051050cd7e905de2c9a7e61790943440b3416f49cb409f965d9dcd0fa73e9"
  end

  resource "anthropic" do
    url "https://files.pythonhosted.org/packages/source/a/anthropic/anthropic-0.42.0.tar.gz"
    sha256 "e8f6f192d3ce8e0d015a3092be1f78b74b93eb6d66f42e3e9000b616c4719c4d"
  end

  resource "pydantic" do
    url "https://files.pythonhosted.org/packages/source/p/pydantic/pydantic-2.10.5.tar.gz"
    sha256 "f2f394c08d2c2df208a9e9c4a826e0b7eb3f59bbbf63f6db2d0a2a722e5a7090"
  end

  resource "structlog" do
    url "https://files.pythonhosted.org/packages/source/s/structlog/structlog-24.4.0.tar.gz"
    sha256 "deb7eed4679ac30132d0b789f201db87b9bb0a2efe4e5ffb21472e99e2253adb"
  end

  # NOTE: Run the following command to regenerate complete dependency list:
  #   cd /tmp && python3 -m venv venv && source venv/bin/activate
  #   pip install claude-code-proxy homebrew-pypi-poet
  #   poet claude-code-proxy > resources.txt
  #
  # Then replace the resource blocks above with the generated output

  def install
    # Install in virtualenv
    virtualenv_install_with_resources

    # Create config directory
    (var/"claude-code-proxy").mkpath

    # Generate sample config if needed
    # (etc/"claude-code-proxy").install "config.example.yaml" if build.head?
  end

  def post_install
    # Create accounts.json directory with proper permissions
    accounts_dir = var/"claude-code-proxy/data"
    accounts_dir.mkpath
    accounts_dir.chmod 0700
  end

  service do
    run [opt_bin/"claude-code-proxy-api", "--host", "0.0.0.0", "--port", "8080"]
    keep_alive true
    working_dir var/"claude-code-proxy"
    log_path var/"log/claude-code-proxy/stdout.log"
    error_log_path var/"log/claude-code-proxy/stderr.log"
    environment_variables PATH: std_service_path_env
  end

  test do
    # Test that the binary exists and returns version
    assert_match version.to_s, shell_output("#{bin}/claude-code-proxy-api --version")

    # Test that Python can import the package
    system Formula["python@3.12"].opt_bin/"python3", "-c", "import claude_code_proxy"

    # Test health endpoint (requires service to be running)
    # This would need additional setup, so we skip it in formula test
  end
end
