<!-- Accounts Table -->
{% if accounts %}
<div class="bg-white rounded-2xl shadow-card border border-slate-200/60 overflow-hidden">
    <table class="w-full">
        <thead>
            <tr class="border-b border-slate-100">
                <th class="px-5 py-3.5 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Account</th>
                <th class="px-5 py-3.5 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                <th class="px-5 py-3.5 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Token</th>
                <th class="px-5 py-3.5 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Capacity</th>
                <th class="px-5 py-3.5 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Last Used</th>
                <th class="px-5 py-3.5 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-50">
            {% for account in accounts %}
            <tr class="hover:bg-slate-50/50 transition-colors duration-150" id="row-{{ account.name }}">
                <td class="px-5 py-4">
                    <!-- Display mode -->
                    <div id="display-{{ account.name }}" class="flex items-center gap-2">
                        <span class="text-sm font-medium text-slate-900">{{ account.name }}</span>
                        {% if account.is_next %}
                        <span class="px-1.5 py-0.5 text-[10px] font-medium text-emerald-600 bg-emerald-50 rounded">NEXT</span>
                        {% endif %}
                        <button
                            onclick="showRenameForm('{{ account.name }}')"
                            class="p-1 text-slate-300 hover:text-slate-500 rounded transition-colors duration-150"
                            title="Rename"
                        >
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Edit mode (hidden by default) -->
                    <form id="rename-{{ account.name }}"
                          class="hidden"
                          hx-post="/accounts/rename/{{ account.name }}"
                          hx-target="body"
                          hx-swap="innerHTML">
                        <div class="flex items-center gap-2">
                            <input type="text"
                                   name="new_name"
                                   value="{{ account.name }}"
                                   pattern="[a-z0-9_-]+"
                                   required
                                   class="w-32 px-2 py-1 text-sm bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-violet-500/20 focus:border-violet-400 focus:bg-white transition-all duration-150 font-medium"
                                   onkeydown="if(event.key==='Escape') hideRenameForm('{{ account.name }}')">
                            <button type="submit"
                                    class="p-1 text-emerald-500 hover:text-emerald-600 rounded transition-colors duration-150"
                                    title="Save">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                            <button type="button"
                                    onclick="hideRenameForm('{{ account.name }}')"
                                    class="p-1 text-slate-400 hover:text-slate-600 rounded transition-colors duration-150"
                                    title="Cancel">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </form>
                </td>
                <td class="px-5 py-4">
                    <div class="flex flex-col gap-0.5">
                        <span class="inline-flex items-center gap-2">
                            {% if account.state == 'available' and not account.is_expired %}
                                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                <span class="text-sm text-slate-600">Ready</span>
                            {% elif account.state == 'rate_limited' %}
                                <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                                <span class="text-sm text-slate-600">Rate Limited</span>
                            {% elif account.state == 'auth_error' or account.is_expired %}
                                <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                <span class="text-sm text-slate-600">{% if account.is_expired %}Expired{% else %}Auth Error{% endif %}</span>
                            {% elif account.state == 'disabled' %}
                                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                                <span class="text-sm text-slate-600">Disabled</span>
                            {% else %}
                                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                                <span class="text-sm text-slate-600">{{ account.state | title }}</span>
                            {% endif %}
                        </span>
                        {% if account.rate_limited_until %}
                        <span class="text-xs text-amber-600">Resets in {{ account.rate_limited_until }}</span>
                        {% endif %}
                        {% if account.last_error %}
                        <span class="text-xs text-red-500 truncate max-w-[180px]" title="{{ account.last_error }}">{{ account.last_error }}</span>
                        {% endif %}
                    </div>
                </td>
                <td class="px-5 py-4">
                    <span class="text-sm {% if account.is_expired %}text-red-500 font-medium{% else %}text-slate-500{% endif %}">
                        {{ account.expires_in }}
                    </span>
                </td>
                <td class="px-5 py-4">
                    <div class="flex flex-col gap-0.5">
                        {% if account.tokens_remaining_percent is not none %}
                            <div class="flex items-center gap-2">
                                <!-- Progress bar -->
                                <div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full {% if account.tokens_remaining_percent > 75 %}bg-emerald-500{% elif account.tokens_remaining_percent > 25 %}bg-amber-500{% else %}bg-red-500{% endif %}"
                                         style="width: {{ account.tokens_remaining_percent }}%"></div>
                                </div>
                                <span class="text-sm {% if account.tokens_remaining_percent > 75 %}text-emerald-600{% elif account.tokens_remaining_percent > 25 %}text-amber-600{% else %}text-red-600{% endif %}">
                                    {{ account.tokens_remaining_percent | round(0) | int }}%
                                </span>
                            </div>
                            {% if account.capacity_checked_at %}
                            <span class="text-xs text-slate-400">{{ account.capacity_checked_at }}</span>
                            {% endif %}
                        {% else %}
                            <span class="text-sm text-slate-400">-</span>
                        {% endif %}
                    </div>
                </td>
                <td class="px-5 py-4">
                    <span class="text-sm text-slate-500">{{ account.last_used or "-" }}</span>
                </td>
                <td class="px-5 py-4 text-right">
                    <div class="inline-flex items-center gap-1">
                        <button
                            hx-post="/accounts/check-capacity/{{ account.name }}"
                            hx-target="body"
                            hx-swap="innerHTML"
                            class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-150"
                            title="Check capacity"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </button>
                        <a href="/accounts/start/{{ account.name }}"
                            class="p-2 text-slate-400 hover:text-violet-600 hover:bg-violet-50 rounded-lg transition-all duration-150"
                            title="Re-authenticate"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                        </a>
                        <button
                            hx-delete="/accounts/delete/{{ account.name }}"
                            hx-target="body"
                            hx-swap="innerHTML"
                            hx-confirm="Delete account {{ account.name }}? This cannot be undone."
                            class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-150"
                            title="Delete"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="bg-white rounded-2xl shadow-card border border-slate-200/60 p-8 text-center">
    <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
    </div>
    <p class="text-sm text-slate-500">No accounts configured yet</p>
    <p class="text-xs text-slate-400 mt-1">Add your first account below to get started</p>
</div>
{% endif %}
