<!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 z-50 overflow-y-auto fade-in" style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-slate-900">Model Settings</h2>
                    <p class="text-sm text-slate-500 mt-0.5">All models use your Claude subscription</p>
                </div>
                <button
                    onclick="document.getElementById('settings-modal').remove()"
                    class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all duration-150"
                    title="Close"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Status message -->
                <div id="modal-status-message"></div>

                <!-- Model List Provider Section -->
                <div>
                    <h3 class="text-sm font-semibold text-slate-900 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        Model List Provider
                    </h3>

                    {% set providers = [
                        {'value': 'anthropic', 'label': 'Anthropic', 'abbrev': 'A', 'color': 'bg-slate-900'},
                        {'value': 'openrouter', 'label': 'OpenRouter', 'abbrev': 'OR', 'color': 'bg-emerald-600'},
                        {'value': 'litellm', 'label': 'LiteLLM', 'abbrev': 'LL', 'color': 'bg-blue-600'}
                    ] %}

                    <form id="provider-form" class="grid gap-2">
                        {% for provider in providers %}
                        {% set is_selected = settings.provider == provider.value %}
                        <label class="flex items-center p-3 rounded-xl border cursor-pointer transition-all duration-150 hover:bg-slate-50
                            {% if is_selected %}border-violet-300 bg-violet-50{% else %}border-slate-200{% endif %}">
                            <input
                                type="radio"
                                name="provider"
                                value="{{ provider.value }}"
                                class="sr-only provider-radio"
                                {% if is_selected %}checked{% endif %}
                                hx-post="/settings/update-provider"
                                hx-target="#modal-status-message"
                                hx-swap="innerHTML"
                                hx-on::after-request="updateModels(event)"
                            >
                            <div class="w-8 h-8 rounded-lg {{ provider.color }} flex items-center justify-center text-white text-xs font-bold mr-3">{{ provider.abbrev }}</div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-slate-900">{{ provider.label }}</div>
                            </div>
                            <div class="w-4 h-4 rounded-full border-2 flex items-center justify-center
                                {% if is_selected %}border-violet-600 bg-violet-600{% else %}border-slate-300{% endif %}">
                                {% if is_selected %}
                                <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                                {% endif %}
                            </div>
                        </label>
                        {% endfor %}
                    </form>
                </div>

                <!-- Tier Defaults Section with Fallback Toggles -->
                <div>
                    <h3 class="text-sm font-semibold text-slate-900 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        Default Models
                    </h3>

                    {% set tiers = [
                        {'name': 'sonnet', 'label': 'Sonnet', 'color': 'bg-violet-500'},
                        {'name': 'opus', 'label': 'Opus', 'color': 'bg-amber-500'},
                        {'name': 'haiku', 'label': 'Haiku', 'color': 'bg-emerald-500'}
                    ] %}

                    <form id="tier-defaults-form" hx-post="/settings/update-tier-defaults" hx-target="#modal-status-message" hx-swap="innerHTML" class="space-y-4">
                        {% for tier in tiers %}
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-medium text-slate-700 flex items-center gap-1.5">
                                    <span class="w-2 h-2 rounded-full {{ tier.color }}"></span>
                                    {{ tier.label }}
                                </label>
                                <!-- Per-tier fallback toggle -->
                                <label class="flex items-center gap-2 cursor-pointer" title="Enable fallback for {{ tier.label }}">
                                    <span class="text-xs text-slate-500">Fallback</span>
                                    <div class="relative inline-flex items-center">
                                        <input
                                            type="checkbox"
                                            name="{{ tier.name }}_fallback"
                                            class="sr-only peer"
                                            {% if settings.enable_fallback %}checked{% endif %}
                                        >
                                        <div class="w-8 h-4 bg-slate-300 peer-focus:ring-2 peer-focus:ring-violet-500/20 rounded-full peer peer-checked:after:translate-x-4 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-violet-600"></div>
                                    </div>
                                </label>
                            </div>
                            <select
                                id="{{ tier.name }}-select"
                                name="{{ tier.name }}_default"
                                class="w-full px-3 py-2 text-sm bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-violet-500/20 focus:border-violet-400 transition-all duration-150"
                            >
                                {% for model in available_models[tier.name] %}
                                <option value="{{ model }}" {% if settings.tier_defaults[tier.name] == model %}selected{% endif %}>{{ model }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endfor %}

                        <div class="flex gap-2">
                            <button
                                type="submit"
                                class="flex-1 px-4 py-2 text-sm font-medium text-white bg-slate-900 rounded-lg hover:bg-slate-800 transition-all duration-150"
                            >
                                Save Defaults
                            </button>
                            <button
                                type="button"
                                onclick="testModels()"
                                class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-all duration-150"
                            >
                                Test Models
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Radio button styling
document.querySelectorAll('.provider-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.provider-radio').forEach(r => {
            r.closest('label').classList.remove('border-violet-300', 'bg-violet-50')
            r.closest('label').classList.add('border-slate-200')
            const indicator = r.closest('label').querySelector('.rounded-full:last-child')
            if (indicator) {
                indicator.classList.remove('border-violet-600', 'bg-violet-600')
                indicator.classList.add('border-slate-300')
                indicator.innerHTML = ''
            }
        })

        if (this.checked) {
            this.closest('label').classList.remove('border-slate-200')
            this.closest('label').classList.add('border-violet-300', 'bg-violet-50')
            const indicator = this.closest('label').querySelector('.rounded-full:last-child')
            if (indicator) {
                indicator.classList.remove('border-slate-300')
                indicator.classList.add('border-violet-600', 'bg-violet-600')
                indicator.innerHTML = '<svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>'
            }
        }
    })
})

// Update model dropdowns when provider changes
function updateModels(event) {
    const provider = event.detail.elt.value
    const tiers = ['sonnet', 'opus', 'haiku']
    // Stagger requests to avoid HTMX race condition
    tiers.forEach((tier, index) => {
        setTimeout(() => {
            htmx.ajax('GET', `/settings/models-for-provider?provider=${provider}&tier=${tier}`, {
                target: `#${tier}-select`,
                swap: 'outerHTML'
            })
        }, index * 50)
    })
}

// Test selected models
function testModels() {
    const form = document.getElementById('tier-defaults-form')
    const formData = new FormData(form)
    formData.set('sonnet_model', formData.get('sonnet_default'))
    formData.set('opus_model', formData.get('opus_default'))
    formData.set('haiku_model', formData.get('haiku_default'))

    htmx.ajax('POST', '/settings/test-models', {
        target: '#modal-status-message',
        swap: 'innerHTML',
        values: {
            sonnet_model: formData.get('sonnet_default'),
            opus_model: formData.get('opus_default'),
            haiku_model: formData.get('haiku_default')
        }
    })
}
</script>
